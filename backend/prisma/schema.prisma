generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =============================================================================
// CORE MODELS
// =============================================================================

model Organization {
  id        String   @id @default(uuid())
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  users     User[]
  offerings Offering[]
  developmentProjects DevelopmentProject[]
}

model User {
  id           String       @id @default(uuid())
  email        String       @unique
  passwordHash String
  orgId        String
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  assignedTasks    Task[]       @relation("TaskAssignee")
  dailyLogsCreated DailyLog[]
  rfiResponses     Rfi[]
  inspectionLead   Inspection[]
  bankAccounts     BankAccount[]
  transactionsFrom Transaction[] @relation("TransactionsFrom")
  transactionsTo   Transaction[] @relation("TransactionsTo")
  complianceChecks ComplianceCheck[]
  taxDocuments     TaxDocument[]

  @@index([orgId])
}

model Offering {
  id             String       @id @default(uuid())
  name           String
  status         String       @default("draft")
  regulationMode String       // '506b' | '506c' | 'internal'
  orgId          String
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  organization   Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  developmentProjects DevelopmentProject[]
  transactions   Transaction[]
  escrowAccount  EscrowAccount?
  distributions  Distribution[]
  investments    Investment[]
  taxDocuments   TaxDocument[]

  @@index([orgId])
}

// =============================================================================
// CONSTRUCTION PROJECT MANAGEMENT
// =============================================================================

model DevelopmentProject {
  id          String   @id @default(uuid())
  name        String
  address     String?
  projectType String?  // NEW_CONSTRUCTION | RENOVATION | MULTI_FAMILY | COMMERCIAL
  orgId       String
  offeringId  String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  offering     Offering?     @relation(fields: [offeringId], references: [id], onDelete: SetNull)
  project      Project?

  @@index([orgId])
  @@index([offeringId])
}

enum ProjectPhase {
  PRE_CONSTRUCTION
  FOUNDATION
  FRAMING
  MEP_ROUGH_IN
  ENCLOSURE
  INTERIOR_FINISH
  CLOSEOUT
  COMPLETED
}

enum TaskStatus {
  NOT_STARTED
  IN_PROGRESS
  ON_HOLD
  COMPLETED
  CANCELLED
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum WeatherCondition {
  CLEAR
  CLOUDY
  RAIN
  SNOW
  WIND
  EXTREME_HEAT
  EXTREME_COLD
  OTHER
}

enum RfiStatus {
  OPEN
  PENDING_RESPONSE
  ANSWERED
  CLOSED
}

enum SubmittalStatus {
  DRAFT
  SUBMITTED
  UNDER_REVIEW
  APPROVED
  REJECTED
  REVISED
}

enum InspectionStatus {
  SCHEDULED
  IN_PROGRESS
  PASSED
  FAILED
  DEFERRED
  CANCELLED
}

model Project {
  id                    String       @id @default(uuid())
  projectCode           String       @unique
  developmentProjectId  String       @unique
  developmentProject    DevelopmentProject @relation(fields: [developmentProjectId], references: [id], onDelete: Cascade)
  phase                 ProjectPhase @default(PRE_CONSTRUCTION)
  percentComplete       Float        @default(0)
  plannedStartDate      DateTime?
  plannedEndDate        DateTime?
  actualStartDate       DateTime?
  actualEndDate         DateTime?
  totalBudget           Float?
  spentToDate           Float        @default(0)
  scheduleVarianceDays  Int?
  costVariance          Float?
  deletedAt             DateTime?
  createdAt             DateTime     @default(now())
  updatedAt             DateTime     @updatedAt
  tasks                 Task[]
  milestones            Milestone[]
  dailyLogs             DailyLog[]
  rfis                  Rfi[]
  submittals            Submittal[]
  inspections           Inspection[]
  safetyIncidents       SafetyIncident[]

  @@index([developmentProjectId])
  @@index([phase])
  @@index([deletedAt])
  @@map("projects")
}

model Task {
  id                  String       @id @default(uuid())
  projectId           String
  project             Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  parentId            String?
  parent              Task?        @relation("TaskHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children            Task[]       @relation("TaskHierarchy")
  title               String
  description         String?
  status              TaskStatus   @default(NOT_STARTED)
  priority            TaskPriority @default(MEDIUM)
  percentComplete     Float        @default(0)
  plannedStartDate    DateTime?
  plannedEndDate      DateTime?
  actualStartDate     DateTime?
  actualEndDate       DateTime?
  durationDays        Int?
  predecessorTaskIds  String[]     @default([])
  lagDays             Int          @default(0)
  isCriticalPath      Boolean      @default(false)
  budgetAmount        Float?
  actualCost          Float?
  assignedToId        String?
  assignedTo          User?        @relation("TaskAssignee", fields: [assignedToId], references: [id], onDelete: SetNull)
  attachmentUrls      String[]     @default([])
  deletedAt           DateTime?
  createdAt           DateTime     @default(now())
  updatedAt           DateTime     @updatedAt

  @@index([projectId])
  @@index([status])
  @@index([assignedToId])
  @@index([parentId])
  @@index([deletedAt])
  @@map("tasks")
}

model Milestone {
  id              String    @id @default(uuid())
  projectId       String
  project         Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  name            String
  description     String?
  targetDate      DateTime?
  completedDate   DateTime?
  relatedTaskIds  String[]  @default([])
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([projectId])
  @@map("milestones")
}

model DailyLog {
  id              String           @id @default(uuid())
  projectId       String
  project         Project          @relation(fields: [projectId], references: [id], onDelete: Cascade)
  logDate         DateTime
  weather         WeatherCondition?
  temperature     Float?
  laborCount      Json?
  equipmentUsed   String[]         @default([])
  materialsDelivered String?
  workCompleted   String?
  issuesDelays    String?
  visitorLog      String?
  safetyObservations String?
  createdById     String?
  createdBy       User?            @relation(fields: [createdById], references: [id], onDelete: SetNull)
  photoUrls       String[]         @default([])
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  @@unique([projectId, logDate])
  @@index([projectId])
  @@index([logDate])
  @@map("daily_logs")
}

model Rfi {
  id            String    @id @default(uuid())
  projectId     String
  project       Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  rfiNumber     String
  subject       String
  description   String
  status        RfiStatus @default(OPEN)
  response      String?
  respondedById String?
  respondedBy   User?     @relation(fields: [respondedById], references: [id], onDelete: SetNull)
  respondedAt   DateTime?
  dueDate       DateTime?
  attachmentUrls String[] @default([])
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@unique([projectId, rfiNumber])
  @@index([projectId])
  @@index([status])
  @@map("rfis")
}

model Submittal {
  id            String         @id @default(uuid())
  projectId     String
  project       Project        @relation(fields: [projectId], references: [id], onDelete: Cascade)
  submittalNumber String
  name          String
  description   String?
  specSection   String?
  status        SubmittalStatus @default(DRAFT)
  submittedAt   DateTime?
  reviewedAt    DateTime?
  reviewerNotes String?
  attachmentUrls String[]      @default([])
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  @@unique([projectId, submittalNumber])
  @@index([projectId])
  @@index([status])
  @@map("submittals")
}

model Inspection {
  id            String           @id @default(uuid())
  projectId     String
  project       Project          @relation(fields: [projectId], references: [id], onDelete: Cascade)
  inspectionType String
  scheduledDate DateTime?
  completedDate DateTime?
  status        InspectionStatus @default(SCHEDULED)
  result        String?
  notes         String?
  leadInspectorId String?
  leadInspector User?            @relation(fields: [leadInspectorId], references: [id], onDelete: SetNull)
  photoUrls     String[]         @default([])
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt

  @@index([projectId])
  @@index([status])
  @@map("inspections")
}

model SafetyIncident {
  id          String   @id @default(uuid())
  projectId   String
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  incidentType String
  description String
  incidentDate DateTime
  location    String?
  oshaReportable Boolean @default(false)
  correctiveActions String?
  photoUrls   String[] @default([])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([projectId])
  @@index([incidentDate])
  @@map("safety_incidents")
}

model AuditEvent {
  id         String   @id @default(uuid())
  action     String
  entityType String
  entityId   String
  userId     String?
  metadata   Json?
  createdAt  DateTime @default(now())

  @@index([entityType])
  @@index([entityId])
  @@index([createdAt])
  @@map("audit_events")
}

// =============================================================================
// FINANCE & BANKING
// =============================================================================

enum BankAccountType {
  CHECKING
  SAVINGS
  MONEY_MARKET
  BUSINESS_CHECKING
  BUSINESS_SAVINGS
}

enum BankAccountStatus {
  PENDING_VERIFICATION
  VERIFIED
  VERIFICATION_FAILED
  SUSPENDED
  CLOSED
}

enum VerificationMethod {
  PLAID_INSTANT
  MICRO_DEPOSITS
  MANUAL_REVIEW
}

model BankAccount {
  id                 String              @id @default(uuid())
  userId             String
  user               User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  accountType        BankAccountType
  bankName           String?
  accountNumber      String              @db.Text
  routingNumber      String              @db.Text
  accountHolderName  String
  isVerified         Boolean             @default(false)
  status             BankAccountStatus   @default(PENDING_VERIFICATION)
  verificationMethod VerificationMethod?
  plaidItemId        String?             @unique
  plaidAccessToken   String?             @db.Text
  plaidAccountId     String?
  isDefault          Boolean             @default(false)
  lastFourDigits     String?
  verifiedAt         DateTime?
  suspendedAt        DateTime?
  suspensionReason   String?
  metadata           Json?
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  transactions       Transaction[]
  escrowAccounts     EscrowAccount[]

  @@index([userId])
  @@index([status])
  @@index([plaidItemId])
  @@map("bank_accounts")
}

// =============================================================================
// TRANSACTIONS & PAYMENTS
// =============================================================================

enum TransactionType {
  INVESTMENT
  DISTRIBUTION
  REFUND
  FEE
  DRAW_REQUEST
  PROVIDER_PAYMENT
  TRANSFER
  DEPOSIT
  WITHDRAWAL
}

enum TransactionStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
  REFUNDED
  ON_HOLD
  REQUIRES_APPROVAL
}

enum PaymentMethod {
  ACH
  WIRE
  CHECK
  CARD
  INTERNAL
}

model Transaction {
  id                String            @id @default(uuid())
  offeringId        String?
  offering          Offering?         @relation(fields: [offeringId], references: [id], onDelete: SetNull)
  fromUserId        String?
  fromUser          User?             @relation("TransactionsFrom", fields: [fromUserId], references: [id], onDelete: SetNull)
  toUserId          String?
  toUser            User?             @relation("TransactionsTo", fields: [toUserId], references: [id], onDelete: SetNull)
  bankAccountId     String?
  bankAccount       BankAccount?      @relation(fields: [bankAccountId], references: [id], onDelete: SetNull)
  escrowAccountId   String?
  escrowAccount     EscrowAccount?    @relation(fields: [escrowAccountId], references: [id], onDelete: SetNull)
  
  transactionType   TransactionType
  amount            Decimal           @db.Decimal(15, 2)
  currency          String            @default("USD")
  status            TransactionStatus @default(PENDING)
  paymentMethod     PaymentMethod
  
  stripePaymentId   String?           @unique
  plaidTransferId   String?           @unique
  
  description       String
  notes             String?
  metadata          Json?
  
  feeAmount         Decimal?          @db.Decimal(15, 2)
  netAmount         Decimal           @db.Decimal(15, 2)
  
  initiatedAt       DateTime          @default(now())
  processedAt       DateTime?
  completedAt       DateTime?
  failedAt          DateTime?
  cancelledAt       DateTime?
  
  errorMessage      String?
  retryCount        Int               @default(0)
  maxRetries        Int               @default(3)
  
  complianceStatus  String?
  complianceCheckedAt DateTime?
  
  createdBy         String?
  approvedBy        String?
  
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  
  ledgerEntries     EscrowLedgerEntry[]

  @@index([offeringId])
  @@index([fromUserId])
  @@index([toUserId])
  @@index([status])
  @@index([transactionType])
  @@index([initiatedAt])
  @@index([stripePaymentId])
  @@index([plaidTransferId])
  @@map("transactions")
}

// =============================================================================
// ESCROW ACCOUNTS
// =============================================================================

enum EscrowStatus {
  ACTIVE
  SUSPENDED
  CLOSED
  UNDER_REVIEW
}

model EscrowAccount {
  id                String         @id @default(uuid())
  offeringId        String         @unique
  offering          Offering       @relation(fields: [offeringId], references: [id], onDelete: Cascade)
  accountNumber     String         @unique
  accountName       String
  bankAccountId     String?
  bankAccount       BankAccount?   @relation(fields: [bankAccountId], references: [id], onDelete: SetNull)
  balance           Decimal          @db.Decimal(15, 2) @default(0)
  reservedAmount    Decimal          @db.Decimal(15, 2) @default(0)
  availableBalance  Decimal          @db.Decimal(15, 2) @default(0)
  status            EscrowStatus   @default(ACTIVE)
  
  stripeAccountId   String?        @unique
  bankAccountNumber String?
  bankRoutingNumber String?
  
  lastReconciledAt  DateTime?
  lastReconciledBalance Decimal?     @db.Decimal(15, 2)
  
  openedAt          DateTime       @default(now())
  closedAt          DateTime?
  closedReason      String?
  
  metadata          Json?
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  
  transactions      Transaction[]
  distributions     Distribution[]
  ledgerEntries     EscrowLedgerEntry[]

  @@index([offeringId])
  @@index([status])
  @@map("escrow_accounts")
}

enum LedgerEntryType {
  DEPOSIT
  WITHDRAWAL
  DISTRIBUTION
  FEE
  REFUND
  ADJUSTMENT
  RECONCILIATION
}

model EscrowLedgerEntry {
  id                String           @id @default(uuid())
  escrowAccountId   String
  escrowAccount     EscrowAccount    @relation(fields: [escrowAccountId], references: [id], onDelete: Cascade)
  transactionId     String?
  transaction       Transaction?     @relation(fields: [transactionId], references: [id], onDelete: SetNull)
  distributionId    String?
  distribution      Distribution?    @relation(fields: [distributionId], references: [id], onDelete: SetNull)
  
  entryType         LedgerEntryType
  amount            Float
  balanceBefore     Float
  balanceAfter      Float
  description       String
  reference         String?
  
  createdBy         String?
  metadata          Json?
  createdAt         DateTime         @default(now())

  @@index([escrowAccountId])
  @@index([transactionId])
  @@index([distributionId])
  @@index([createdAt])
  @@map("escrow_ledger_entries")
}

// =============================================================================
// DISTRIBUTIONS
// =============================================================================

enum DistributionType {
  RETURN_OF_CAPITAL
  PREFERRED_RETURN
  PROFIT_SPLIT
  SPECIAL_DISTRIBUTION
  EXIT_PROCEEDS
}

enum DistributionStatus {
  DRAFT
  PENDING_APPROVAL
  APPROVED
  PROCESSING
  COMPLETED
  PARTIALLY_COMPLETED
  FAILED
  CANCELLED
}

model Distribution {
  id                String             @id @default(uuid())
  offeringId        String
  offering          Offering           @relation(fields: [offeringId], references: [id], onDelete: Cascade)
  escrowAccountId   String?
  escrowAccount     EscrowAccount?     @relation(fields: [escrowAccountId], references: [id], onDelete: SetNull)
  
  distributionType  DistributionType
  distributionDate  DateTime
  periodStart       DateTime?
  periodEnd         DateTime?
  
  totalAmount       Decimal              @db.Decimal(15, 2)
  status            DistributionStatus @default(DRAFT)
  
  calculations      Json?
  
  createdBy         String?
  approvedBy        String?
  approvedAt        DateTime?
  
  processedAt       DateTime?
  completedAt       DateTime?
  failedAt          DateTime?
  errorMessage      String?
  
  notificationSent  Boolean            @default(false)
  notificationSentAt DateTime?
  
  metadata          Json?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  
  ledgerEntries     EscrowLedgerEntry[]

  @@index([offeringId])
  @@index([status])
  @@index([distributionDate])
  @@map("distributions")
}

// =============================================================================
// INVESTMENTS
// =============================================================================

enum InvestmentStatus {
  PENDING
  ACTIVE
  COMPLETED
  CANCELLED
}

model Investment {
  id                    String            @id @default(uuid())
  investorId            String
  offeringId            String
  offering              Offering          @relation(fields: [offeringId], references: [id], onDelete: Cascade)
  
  investmentAmount      Float
  currentBalance        Float
  returnedCapital       Float             @default(0)
  preferredReturnRate   Float             @default(0.08)
  preferredReturnOwed   Float             @default(0)
  preferredReturnPaid   Float             @default(0)
  profitsPaid           Float             @default(0)
  
  status                InvestmentStatus  @default(PENDING)
  fundedAt              DateTime?
  completedAt           DateTime?
  
  ownershipPercentage   Float?
  equityShares          Int?
  
  metadata              Json?
  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt

  @@index([investorId])
  @@index([offeringId])
  @@index([status])
  @@map("investments")
}

// =============================================================================
// COMPLIANCE
// =============================================================================

enum LimitType {
  DAILY_DEPOSIT
  MONTHLY_DEPOSIT
  ANNUAL_INVESTMENT
  PER_TRANSACTION
  ACCREDITED_INVESTOR
  NON_ACCREDITED_INVESTOR
}

model TransactionLimit {
  id          String    @id @default(uuid())
  limitType   LimitType
  amount      Float
  currency    String    @default("USD")
  description String?
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([limitType])
  @@map("transaction_limits")
}

enum ComplianceCheckType {
  KYC
  AML
  OFAC
  ACCREDITATION
  IDENTITY
  ADDRESS
  BANK_ACCOUNT
}

enum CheckStatus {
  PENDING
  APPROVED
  REJECTED
  EXPIRED
  MANUAL_REVIEW_REQUIRED
}

model ComplianceCheck {
  id                String             @id @default(uuid())
  userId            String
  user              User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  checkType         ComplianceCheckType
  status            CheckStatus        @default(PENDING)
  
  result            Json?
  score             Float?
  flags             String[]           @default([])
  
  documentUrls      String[]           @default([])
  
  externalServiceId String?
  externalService   String?
  
  performedAt       DateTime           @default(now())
  expiresAt         DateTime?
  reviewedBy        String?
  reviewedAt        DateTime?
  notes             String?
  rejectionReason   String?
  
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt

  @@index([userId])
  @@index([checkType])
  @@index([status])
  @@index([performedAt])
  @@index([expiresAt])
  @@map("compliance_checks")
}

// =============================================================================
// TAX DOCUMENTS
// =============================================================================

enum TaxDocumentType {
  FORM_1099
  FORM_K1
  TAX_SUMMARY
  COST_BASIS
  DISTRIBUTION_SUMMARY
}

enum TaxDocumentStatus {
  GENERATING
  READY
  SENT
  FAILED
}

model TaxDocument {
  id                String             @id @default(uuid())
  userId            String
  user              User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  offeringId        String?
  offering          Offering?          @relation(fields: [offeringId], references: [id], onDelete: SetNull)
  
  documentType      TaxDocumentType
  taxYear           Int
  status            TaxDocumentStatus  @default(GENERATING)
  
  documentUrl       String?
  documentHash      String?
  
  taxData           Json?
  
  generatedAt       DateTime?
  sentAt            DateTime?
  sentVia           String?
  downloadedAt      DateTime?
  downloadCount     Int                @default(0)
  
  filedWithIRS      Boolean            @default(false)
  filedAt           DateTime?
  filingConfirmation String?
  
  metadata          Json?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt

  @@index([userId])
  @@index([offeringId])
  @@index([taxYear])
  @@index([documentType])
  @@index([status])
  @@map("tax_documents")
}

// =============================================================================
// AI & ANALYTICS
// =============================================================================

enum AITaskType {
  DOCUMENT_ANALYSIS
  RISK_ASSESSMENT
  FRAUD_DETECTION
  RECOMMENDATION
  CHAT_RESPONSE
  DATA_EXTRACTION
  COMPLIANCE_CHECK
  FINANCIAL_FORECAST
  MARKET_ANALYSIS
}

enum AITaskStatus {
  QUEUED
  PROCESSING
  COMPLETED
  FAILED
}

model AITask {
  id                String       @id @default(uuid())
  taskType          AITaskType
  status            AITaskStatus @default(QUEUED)
  
  inputData         Json?
  userId            String?
  relatedEntityType String?
  relatedEntityId   String?
  
  result            Json?
  confidence        Float?
  insights          Json?
  
  model             String?
  promptTokens      Int?
  completionTokens  Int?
  totalTokens       Int?
  cost              Decimal?       @db.Decimal(10, 4)
  
  processingTime    Int?
  startedAt         DateTime?
  completedAt       DateTime?
  failedAt          DateTime?
  errorMessage      String?
  
  metadata          Json?
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt

  @@index([taskType])
  @@index([status])
  @@index([userId])
  @@index([relatedEntityType, relatedEntityId])
  @@index([createdAt])
  @@map("ai_tasks")
}

model AIInsight {
  id                String   @id @default(uuid())
  insightType       String
  entityType        String
  entityId          String
  
  title             String
  description       String
  severity          String
  confidence        Decimal    @db.Decimal(3, 2)
  
  data              Json?
  recommendations   Json?
  
  viewed            Boolean  @default(false)
  viewedAt          DateTime?
  dismissed         Boolean  @default(false)
  dismissedAt       DateTime?
  actionTaken       String?
  actionTakenAt     DateTime?
  
  generatedBy       String
  aiTaskId          String?
  
  validUntil        DateTime?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([entityType, entityId])
  @@index([insightType])
  @@index([severity])
  @@index([viewed])
  @@index([createdAt])
  @@map("ai_insights")
}
